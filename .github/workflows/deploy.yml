name: Deploy Cloud Function

on:
  push:
    branches: [master]

jobs:
  deploy:
    name: Deploy to Google Cloud
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write' # Required for Workload Identity Federation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/857835268341/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
        service_account: 'cloud-functions-deployer@calm-cab-458210-t2.iam.gserviceaccount.com'

    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: Deploy Cloud Function
      run: |
        cd functions/hello-world
        gcloud functions deploy hello-world \
          --runtime=go122 \
          --trigger-http \
          --entry-point=HelloWorld \
          --region=us-central1 \
          --service-account=cloud-functions-deployer@calm-cab-458210-t2.iam.gserviceaccount.com \
          --allow-unauthenticated \
          --project=calm-cab-458210-t2
            